<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Availability Calendar</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      background: #f6f6f6;
    }
    h1 { margin: 10px 0; }
    #user-setup {
      margin: 20px auto;
      background: #fff;
      padding: 10px;
      border-radius: 6px;
      width: 280px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    #calendar {
      margin: 20px auto;
      overflow-x: auto;
      display: none;
    }
    table {
      border-collapse: collapse;
      margin: 0 auto;
      min-width: 700px;
    }
    th, td {
      border: 1px solid #ccc;
      width: 100px;
      height: 50px;
      text-align: center;
      vertical-align: middle;
    }
    th {
      background: #eaeaea;
      position: sticky;
      top: 0;
    }
    .day-header {
      font-weight: bold;
    }
    .monthday {
      font-size: 13px;
      color: #555;
      margin-top: -34px;
      display: block;
    }
    .time-label {
      font-weight: bold;
      width: 120px;
      background: #f0f0f0;
    }
    #legend {
      margin-top: 20px;
      text-align: left;
      width: 280px;
      background: #fff;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: none;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin: 5px 0;
    }
    .color-box {
      width: 20px;
      height: 20px;
      margin-right: 8px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h1>Group Availability</h1>

  <div id="user-setup">
    <label>Name: <input type="text" id="userName" /></label><br><br>
    <label>Colour: <input type="color" id="userColor" /></label><br><br>
    <button id="saveBtn">Save</button>
  </div>

  <div id="calendar">
    <table id="availabilityTable"></table>
  </div>

  <div id="legend">
    <h3>Legend</h3>
    <div id="legendList"></div>
  </div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

// üîê Replace these two values with your actual Supabase project credentials
const SUPABASE_URL = "https://btuuowyvemesakjzkkzv.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ0dXVvd3l2ZW1lc2Franpra3p2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0ODIwMDEsImV4cCI6MjA3NzA1ODAwMX0.QsDXg8AigiKUnpBUomprfbhx3RHzu-m12s2t4SKrhgM";

const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
window.supabase = supabase; // for debugging if needed

const table = document.getElementById("availabilityTable");
const legendDiv = document.getElementById("legend");
const legendList = document.getElementById("legendList");

let user = JSON.parse(localStorage.getItem("user") || "null");

document.getElementById("saveBtn").addEventListener("click", async () => {
  const name = document.getElementById("userName").value.trim();
  const color = document.getElementById("userColor").value.trim();
  if (!name) return alert("Please enter a name");
  user = { name, color };
  localStorage.setItem("user", JSON.stringify(user));
  document.getElementById("user-setup").style.display = "none";
  document.getElementById("calendar").style.display = "block";
  legendDiv.style.display = "block";
  await loadAvailability();
});

if (user) {
  document.getElementById("user-setup").style.display = "none";
  document.getElementById("calendar").style.display = "block";
  legendDiv.style.display = "block";
}

// üóìÔ∏è Helpers for dates
function getStartDate() {
  const stored = localStorage.getItem("startDate");
  return stored ? new Date(stored) : new Date();
}
function setStartDate(date) {
  localStorage.setItem("startDate", date.toISOString());
}

// üß© Build the calendar grid
function buildCalendar(startDate) {
  table.innerHTML = "";
  const headerRow = document.createElement("tr");
  const emptyHeader = document.createElement("th");
  headerRow.appendChild(emptyHeader);

  const days = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date(startDate);
    d.setDate(d.getDate() + i);
    days.push(d);
    const th = document.createElement("th");
    th.className = "day-header";
    th.innerHTML = `${d.toLocaleDateString("en-US",{weekday:"short"})}<br><span class="monthday">${d.getDate()}/${d.getMonth()+1}</span>`;
    headerRow.appendChild(th);
  }
  table.appendChild(headerRow);

  const times = ["Morning","Pre-Lunch","Post-Lunch","Evening"];
  times.forEach((time, r) => {
    const row = document.createElement("tr");
    const label = document.createElement("td");
    label.className = "time-label";
    label.textContent = time;
    row.appendChild(label);
    for (let d = 0; d < 7; d++) {
      const cell = document.createElement("td");
      cell.dataset.day = d;
      cell.dataset.time = time;
      cell.addEventListener("click", () => toggleAvailability(cell));
      row.appendChild(cell);
    }
    table.appendChild(row);
  });
}

// üé® Toggle availability
async function toggleAvailability(cell) {
  if (!user) return;
  const day = parseInt(cell.dataset.day);
  const time = cell.dataset.time;
  const { data: existing } = await supabase
    .from("availability")
    .select("*")
    .eq("day", day)
    .eq("time", time)
    .eq("name", user.name);

  if (existing.length) {
    await supabase.from("availability").delete().eq("id", existing[0].id);
  } else {
    await supabase.from("availability").insert([{ day, time, name: user.name, color: user.color }]);
  }
  await loadAvailability();
}

// üß† Load and render availability
async function loadAvailability() {
  const { data } = await supabase.from("availability").select("*");
  const cells = table.querySelectorAll("td[data-day]");
  cells.forEach(cell => cell.style.background = "");
  if (!data) return;

  const users = {};
  data.forEach(r => { users[r.name] = r.color; });

  legendList.innerHTML = "";
  Object.entries(users).forEach(([name, color]) => {
    const div = document.createElement("div");
    div.className = "legend-item";
    div.innerHTML = `<div class="color-box" style="background:${color}"></div>${name}`;
    legendList.appendChild(div);
  });

  for (const record of data) {
    const selector = `td[data-day="${record.day}"][data-time="${record.time}"]`;
    const cell = table.querySelector(selector);
    if (!cell) continue;
    const current = cell.dataset.colors ? cell.dataset.colors.split(",") : [];
    if (!current.includes(record.color)) current.push(record.color);
    cell.dataset.colors = current.join(",");
    cell.style.background = current.length > 1
      ? `linear-gradient(to right, ${current.join(",")})`
      : current[0];
  }
}

// üïí Daily shift check
async function shiftAvailabilityDates() {
  console.log("Shifting stored availability day indexes...");

  // 1Ô∏è‚É£ Delete anything in the first column (yesterday)
  await supabase.from("availability").delete().eq("day", 0);

  // 2Ô∏è‚É£ Fetch the remaining rows so we can update them manually
  const { data: rows, error } = await supabase
    .from("availability")
    .select("*")
    .order("day", { ascending: true });

  if (error) {
    console.error("Error fetching rows for shift:", error);
    return;
  }

  // 3Ô∏è‚É£ Build a list of update promises
  const updates = [];
  for (const r of rows) {
    if (r.day >= 1 && r.day <= 6) {
      updates.push(
        supabase
          .from("availability")
          .update({ day: r.day - 1 })
          .eq("id", r.id)
      );
    }
  }

  // 4Ô∏è‚É£ Execute all updates sequentially (to avoid overlaps)
  for (const u of updates) {
    const { error } = await u;
    if (error) console.error("Shift update error:", error);
  }

  // 5Ô∏è‚É£ Clear the new rightmost column (day 6)
  await supabase.from("availability").delete().eq("day", 6);

  console.log("‚úÖ Shift complete for new day");
}

async function dailyShiftIfNeeded() {
  const today = new Date();
  const saved = getStartDate();
  const todayISO = today.toISOString().split("T")[0];
  const savedISO = saved ? saved.toISOString().split("T")[0] : null;

  if (!saved) { setStartDate(today); return; }
  if (todayISO === savedISO) return;

  console.log("üåÖ New day detected ‚Äì shifting schedule...");
  await shiftAvailabilityDates();
  setStartDate(today);
  await loadAvailability();
}

// üöÄ Initialize
buildCalendar(getStartDate());
dailyShiftIfNeeded().then(loadAvailability);
</script>
</body>
</html>
