<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Availability Calendar</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      background: #f6f6f6;
    }
    h1 { margin: 10px 0; }

    #user-setup {
      margin: 20px auto;
      background: #fff;
      padding: 10px;
      border-radius: 6px;
      width: 280px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    #calendar {
      margin: 20px auto;
      overflow-x: auto;
      display: none;
    }
    table {
      border-collapse: collapse;
      margin: 0 auto;
      min-width: 700px;
    }
    th, td {
      border: 1px solid #ccc;
      width: 100px;
      height: 50px;
      text-align: center;
      vertical-align: middle;
    }
    th {
      background: #eaeaea;
      position: sticky;
      top: 0;
    }
    .day-header { font-weight: bold; }
    .monthday {
      font-size: 13px;
      color: #555;
      margin-top: -34px;
      display: block;
    }
    .time-label {
      font-weight: bold;
      width: 120px;
      background: #f0f0f0;
    }
    #legend {
      margin-top: 20px;
      text-align: left;
      width: 280px;
      background: #fff;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: none;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin: 5px 0;
    }
    .color-box {
      width: 20px;
      height: 20px;
      margin-right: 8px;
      border: 1px solid #ccc;
    }

    td {
      transition: box-shadow 0.3s ease, background 0.3s ease;
    }

    td:hover {
      outline: 1px solid rgba(255, 215, 0, 0.3);
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Group Availability</h1>

  <div id="user-setup">
    <label>Name: <input type="text" id="userName" /></label><br><br>
    <label>Colour: <input type="color" id="userColor" /></label><br><br>
    <button id="saveBtn">Save</button>
  </div>

  <div id="calendar">
    <table id="availabilityTable"></table>
  </div>

  <div id="legend">
    <h3>Legend</h3>
    <div id="legendList"></div>
  </div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

// üîê Supabase credentials
const SUPABASE_URL = "https://btuuowyvemesakjzkkzv.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ0dXVvd3l2ZW1lc2Franpra3p2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0ODIwMDEsImV4cCI6MjA3NzA1ODAwMX0.QsDXg8AigiKUnpBUomprfbhx3RHzu-m12s2t4SKrhgM";
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const table = document.getElementById("availabilityTable");
const legendDiv = document.getElementById("legend");
const legendList = document.getElementById("legendList");

let user = JSON.parse(localStorage.getItem("user") || "null");

document.getElementById("saveBtn").addEventListener("click", async () => {
  const name = document.getElementById("userName").value.trim();
  const color = document.getElementById("userColor").value.trim();
  if (!name) return alert("Please enter a name");
  user = { name, color };
  localStorage.setItem("user", JSON.stringify(user));
  document.getElementById("user-setup").style.display = "none";
  document.getElementById("calendar").style.display = "block";
  legendDiv.style.display = "block";
  await loadAvailability();
});

if (user) {
  document.getElementById("user-setup").style.display = "none";
  document.getElementById("calendar").style.display = "block";
  legendDiv.style.display = "block";
}

// üóìÔ∏è Date helpers
function getStartDate() {
  const stored = localStorage.getItem("startDate");
  return stored ? new Date(stored) : new Date();
}
function setStartDate(date) {
  localStorage.setItem("startDate", date.toISOString());
}

// üß© Build calendar grid
function buildCalendar(startDate) {
  table.innerHTML = "";
  const headerRow = document.createElement("tr");
  headerRow.appendChild(document.createElement("th"));

  const days = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date(startDate);
    d.setDate(d.getDate() + i);
    days.push(d);
    const th = document.createElement("th");
    th.className = "day-header";
    th.innerHTML = `${d.toLocaleDateString("en-US",{weekday:"short"})}<br><span class="monthday">${d.getDate()}/${d.getMonth()+1}</span>`;
    headerRow.appendChild(th);
  }
  table.appendChild(headerRow);

  const times = ["Morning","Pre-Lunch","Post-Lunch","Evening"];
  times.forEach(time => {
    const row = document.createElement("tr");
    const label = document.createElement("td");
    label.className = "time-label";
    label.textContent = time;
    row.appendChild(label);
    for (let d = 0; d < 7; d++) {
      const cell = document.createElement("td");
      cell.dataset.day = d;
      cell.dataset.time = time;
      cell.addEventListener("click", () => toggleAvailability(cell));
      row.appendChild(cell);
    }
    table.appendChild(row);
  });
}

// üé® Toggle availability (add or remove user's colour)
async function toggleAvailability(cell) {
  if (!user) return;
  const day = parseInt(cell.dataset.day);
  const time = cell.dataset.time;

  const { data: existing } = await supabase
    .from("availability")
    .select("*")
    .eq("day", day)
    .eq("time", time)
    .eq("name", user.name);

  if (existing.length) {
    // remove user's colour (even if gold cell)
    await supabase.from("availability").delete().eq("id", existing[0].id);
  } else {
    await supabase.from("availability").insert([{ day, time, name: user.name, color: user.color }]);
  }

  await loadAvailability();
}

// üß† Load and render all availability
async function loadAvailability() {
  const { data } = await supabase.from("availability").select("*");
  const cells = table.querySelectorAll("td[data-day]");
  cells.forEach(cell => {
    cell.style.background = "";
    cell.style.boxShadow = "none";
    cell.innerHTML = "";
  });
  if (!data) return;

  // Build legend
  const users = {};
  data.forEach(r => { users[r.name] = r.color; });
  legendList.innerHTML = "";
  Object.entries(users).forEach(([name, color]) => {
    const div = document.createElement("div");
    div.className = "legend-item";
    div.innerHTML = `<div class="color-box" style="background:${color}"></div>${name}`;
    legendList.appendChild(div);
  });

  // Group entries by cell (day+time)
  const cellMap = {};
  data.forEach(entry => {
    const key = `${entry.day}-${entry.time}`;
    if (!cellMap[key]) cellMap[key] = [];
    cellMap[key].push(entry);
  });

  // Render each cell
  document.querySelectorAll("td[data-day]").forEach(cell => {
    const day = cell.getAttribute("data-day");
    const time = cell.getAttribute("data-time");
    const key = `${day}-${time}`;
    const entries = cellMap[key] || [];

    if (entries.length === 4) {
      cell.style.background = "gold";
      cell.style.boxShadow = "0 0 10px 3px gold";
      return;
    }

    if (entries.length > 0) {
      const dotContainer = document.createElement("div");
      dotContainer.style.display = "flex";
      dotContainer.style.justifyContent = "center";
      dotContainer.style.alignItems = "center";
      dotContainer.style.height = "100%";
      dotContainer.style.gap = "3px";

      entries.forEach(entry => {
        const dot = document.createElement("div");
        dot.style.width = "10px";
        dot.style.height = "10px";
        dot.style.borderRadius = "50%";
        dot.style.background = entry.color;
        dot.style.border = "1px solid rgba(0,0,0,0.2)";
        dot.title = entry.name; // üëà shows user‚Äôs name on hover
        dotContainer.appendChild(dot);
      });

      cell.appendChild(dotContainer);
    }
  });
}

// üïí Shift logic (still used by cron/SQL)
async function shiftAvailabilityDates() {
  await supabase.from("availability").delete().eq("day", 0);
  const { data: rows } = await supabase.from("availability").select("*").order("day");
  for (const r of rows) {
    if (r.day >= 1 && r.day <= 6)
      await supabase.from("availability").update({ day: r.day - 1 }).eq("id", r.id);
  }
  await supabase.from("availability").delete().eq("day", 6);
}

// üïò Daily check
async function dailyShiftIfNeeded() {
  const today = new Date();
  const saved = getStartDate();
  const todayISO = today.toISOString().split("T")[0];
  const savedISO = saved ? saved.toISOString().split("T")[0] : null;
  if (!saved) { setStartDate(today); return; }
  if (todayISO === savedISO) return;
  await shiftAvailabilityDates();
  setStartDate(today);
  await loadAvailability();
}

// üöÄ Initialize
buildCalendar(getStartDate());
dailyShiftIfNeeded().then(loadAvailability);
</script>
</body>
</html>
