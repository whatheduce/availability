<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Availability Calendar</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      background: #f6f6f6;
    }
    h1 { margin: 10px 0; }

    /* user select (tap-to-enter) */
    #user-select {
      display: none;
      margin: 20px auto;
    }
    #user-buttons {
      display:flex;
      justify-content:center;
      gap:20px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .user-btn {
      color: #fff;
      border: none;
      padding: 12px 20px;
      font-size: 18px;
      border-radius: 8px;
      cursor: pointer;
    }

    #calendar {
      margin: 20px auto;
      overflow-x: auto;
      display: none;
    }
    table {
      border-collapse: collapse;
      margin: 0 auto;
      min-width: 700px;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #ccc;
      width: 70px;
      min-width: 70px;
      max-width:70px;
      height: 50px;
      text-align: center;
      vertical-align: middle;
      box-sizing: border-box;
      overflow: hidden;
    }
    th {
      background: #eaeaea;
      position: sticky;
      top: 0;
    }
    .day-header { font-weight: bold; }

    .monthday {
      font-size: 13px;
      color: #555;
      margin-top: -34px;
      display: block;
    }

    .time-label {
      font-weight: bold;
      width: 120px;
      background: #f0f0f0;
    }

    #legend {
      margin-top: 20px;
      text-align: left;
      width: 280px;
      background: #fff;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: none;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin: 5px 0;
    }
    .color-box {
      width: 20px;
      height: 20px;
      margin-right: 8px;
      border: 1px solid #ccc;
    }

    .footer-text {
      text-align: left;
      margin-left: 20px;
      margin-top: 8px;
      margin-bottom: 30px;
    }

    td {
      transition: box-shadow 0.3s ease, background 0.3s ease;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    td:hover {
      outline: 1px solid rgba(255, 215, 0, 0.3);
      cursor: pointer;
    }

    /* dot container */
    .dot-container {
      display:flex;
      justify-content:center;
      align-items:center;
      gap:6px;
      width:100%;
    }
    .dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 1px solid rgba(0,0,0,0.2);
      flex: 0 0 auto;
    }

    /* Gold glowing highlight */
    .gold-cell {
      background: gold !important;
      box-shadow: 0 0 10px 3px gold !important;
    }
  </style>
</head>
<body>

<h1>Group Availability</h1>

<!-- user selection -->
<div id="user-select">
  <h2>Select your name</h2>
  <div id="user-buttons"></div>
</div>

<!-- calendar -->
<div id="calendar">
  <table id="availabilityTable"></table>
</div>

<!-- footer (now correctly OUTSIDE the table) -->
<div class="footer-text">
  - Morning denotes availability starting quite early, assumedly before 10am. <br>
  - Pre-Lunch means you'd be around for lunch, probably starting something like 11-12am. <br>
  - Post-Lunch you're looking at something around 1-3pm, up until around dinner time. <br>
  - Dinner I'd say falls around the 5pm+ region, ending around 9pm <br>
  - Late-Evening we're talking about you around after our earlier 9pm finishes until late, like 11+ or so.
</div>

<div id="legend">
  <h3>Legend</h3>
  <div id="legendList"></div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

/* Supabase credentials */
const SUPABASE_URL = "https://btuuowyvemesakjzkkzv.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ0dXVvd3l2ZW1lc2Franpra3p2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0ODIwMDEsImV4cCI6MjA3NzA1ODAwMX0.QsDXg8AigiKUnpBUomprfbhx3RHzu-m12s2t4SKrhgM";
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

/* DOM refs */
const table = document.getElementById("availabilityTable");
const legendDiv = document.getElementById("legend");
const legendList = document.getElementById("legendList");

/* persistent user */
let user = JSON.parse(localStorage.getItem("user") || "null");

/* 4 permanent users */
const predefinedUsers = [
  { name: "Duce",   color: "#e74c3c" },
  { name: "Mike",  color: "#3498db" },
  { name: "Gway", color: "#2ecc71" },
  { name: "Bone",   color: "#9b59b6" }
];

/* === Date tracking === */
function getStartDate() {
  const stored = localStorage.getItem("startDate");
  return stored ? new Date(stored) : new Date();
}
function setStartDate(date) {
  localStorage.setItem("startDate", date.toISOString());
}

/* === Build Calendar (5 rows, 30 days) === */
function buildCalendar(startDate) {
  table.innerHTML = "";

  /* header */
  const headerRow = document.createElement("tr");
  const empty = document.createElement("th");
  headerRow.appendChild(empty);

  for (let i = 0; i < 30; i++) {
    const d = new Date(startDate);
    d.setDate(d.getDate() + i);

    const th = document.createElement("th");
    th.className = "day-header";
    th.innerHTML =
      `${d.toLocaleDateString("en-US", { weekday: "short" })}<br>` +
      `<span class="monthday">${d.getDate()}/${d.getMonth()+1}</span>`;

    headerRow.appendChild(th);
  }

  table.appendChild(headerRow);

  /* time rows */
  const times = ["Morning","Pre-Lunch","Post-Lunch","Dinner","Late-Evening"];

  times.forEach(time => {
    const row = document.createElement("tr");

    const label = document.createElement("td");
    label.className = "time-label";
    label.textContent = time;
    row.appendChild(label);

    for (let d = 0; d < 30; d++) {
      const cell = document.createElement("td");
      cell.dataset.day = d;
      cell.dataset.time = time;
      cell.addEventListener("click", () => toggleAvailability(cell));
      row.appendChild(cell);
    }

    table.appendChild(row);
  });
}

/* === Toggle (insert/remove Supabase row) === */
async function toggleAvailability(cell) {
  if (!user) return;
  const day = parseInt(cell.dataset.day, 10);
  const time = cell.dataset.time;

  const { data: existing } = await supabase
    .from("availability")
    .select("*")
    .eq("day", day)
    .eq("time", time)
    .eq("name", user.name);

  if (existing && existing.length) {
    await supabase.from("availability").delete().eq("id", existing[0].id);
  } else {
    await supabase.from("availability").insert([
      { day, time, name: user.name, color: user.color }
    ]);
  }

  await loadAvailability();
}

/* === Render dots + gold === */
async function loadAvailability() {
  const { data } = await supabase.from("availability").select("*");
  const cells = table.querySelectorAll("td[data-day]");

  cells.forEach(cell => {
    cell.innerHTML = "";
    cell.classList.remove("gold-cell");
    cell.style.background = "";
    cell.style.boxShadow = "none";
  });

  if (!data) return;

  /* Legend */
  const users = {};
  data.forEach(r => { users[r.name] = r.color; });
  legendList.innerHTML = "";
  Object.entries(users).forEach(([name, color]) => {
    const div = document.createElement("div");
    div.className = "legend-item";
    div.innerHTML = `<div class="color-box" style="background:${color}"></div>${name}`;
    legendList.appendChild(div);
  });

  /* Group by cell */
  const map = {};
  data.forEach(entry => {
    const key = `${entry.day}-${entry.time}`;
    if (!map[key]) map[key] = [];
    map[key].push(entry);
  });

  /* Render cells */
  document.querySelectorAll("td[data-day]").forEach(cell => {
    const day = cell.dataset.day;
    const time = cell.dataset.time;
    const key = `${day}-${time}`;
    const entries = map[key] || [];

    if (entries.length === 4) {
      cell.classList.add("gold-cell");
      return;
    }

    if (entries.length > 0) {
      const dotContainer = document.createElement("div");
      dotContainer.className = "dot-container";

      entries.forEach(entry => {
        const dot = document.createElement("div");
        dot.className = "dot";
        dot.style.background = entry.color;
        dot.title = entry.name;
        dotContainer.appendChild(dot);
      });

      cell.appendChild(dotContainer);
    }
  });
}

/* === Daily shift === */
async function shiftAvailabilityDates() {
  await supabase.from("availability").delete().eq("day", 0);

  const { data: rows } = await supabase
    .from("availability")
    .select("*")
    .order("day", { ascending: true });

  for (const r of rows) {
    if (r.day >= 1 && r.day <= 29) {
      await supabase.from("availability")
        .update({ day: r.day - 1 })
        .eq("id", r.id);
    }
  }

  await supabase.from("availability").delete().eq("day", 29);
}

async function dailyShiftIfNeeded() {
  const today = new Date();
  const saved = getStartDate();
  const tISO = today.toISOString().split("T")[0];
  const sISO = saved ? saved.toISOString().split("T")[0] : null;

  if (!saved) { setStartDate(today); return; }
  if (tISO === sISO) return;

  await shiftAvailabilityDates();
  setStartDate(today);
  await loadAvailability();
}

/* === User Selection UI === */
function showUserSelect() {
  document.getElementById("user-select").style.display = "block";
  const btnArea = document.getElementById("user-buttons");
  btnArea.innerHTML = "";

  predefinedUsers.forEach(u => {
    const btn = document.createElement("button");
    btn.className = "user-btn";
    btn.textContent = u.name;
    btn.style.background = u.color;
    btn.onclick = () => selectUser(u);
    btnArea.appendChild(btn);
  });
}

function selectUser(u) {
  user = { name: u.name, color: u.color };
  localStorage.setItem("user", JSON.stringify(user));

  document.getElementById("user-select").style.display = "none";
  document.getElementById("calendar").style.display = "block";
  legendDiv.style.display = "block";

  buildCalendar(getStartDate());
  loadAvailability();
}

/* === Startup === */
buildCalendar(getStartDate());

if (user) {
  document.getElementById("calendar").style.display = "block";
  legendDiv.style.display = "block";
  dailyShiftIfNeeded().then(loadAvailability);
} else {
  showUserSelect();
  dailyShiftIfNeeded();
}
</script>

</body>
</html>
